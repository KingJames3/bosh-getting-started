#!/usr/bin/env ruby

require "fileutils"

access_key = ARGV.shift
secret_key = ARGV.shift
keypair_name = ARGV.shift || "ec2"
user = "vcap"

unless secret_key
  $stderr.puts "USAGE: create_keypair ACCESS_KEY SECRET_KEY [KEYNAME=ec2]"
  exit 1
end

def create_keypair(access_key, secret_key, keypair_name)
  connection = Fog::Compute.new({
    :provider => 'AWS', :region => 'us-east-1',
    :aws_access_key_id => access_key,
    :aws_secret_access_key => secret_key,
  })
  kp = connection.key_pairs.create(:name => keypair_name)
  pem = "/home/#{user}/.ssh/#{keypair_name}.pem"
  kp.write(pem)
  pem
end

pem = create_keypair(access_key, secret_key, keypair_name)
FileUtils.chown user, user, pem